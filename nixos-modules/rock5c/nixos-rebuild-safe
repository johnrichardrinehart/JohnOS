#!/usr/bin/env bash
# nixos-rebuild-safe: Rebuild NixOS directly to eMMC, bypassing overlay store
# This ensures the system can boot without the SSD.
#
# Strategy:
# 1. Build the system while overlay is active (so all store paths are accessible)
# 2. Record the toplevel path
# 3. Unmount overlay, restart daemon with eMMC-only store
# 4. Fetch the system from binary cache to eMMC
# 5. Activate the system

set -euo pipefail

if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root (use sudo)"
    exit 1
fi

# Parse arguments to extract flake reference and action
action=""
flake_ref=""
extra_args=()

for arg in "$@"; do
    case "$arg" in
        switch|boot|test|build|dry-build|dry-activate)
            action="$arg"
            ;;
        --flake)
            # Next arg will be the flake ref, handled below
            extra_args+=("$arg")
            ;;
        *)
            extra_args+=("$arg")
            # Check if previous was --flake
            if [[ "${extra_args[-2]:-}" == "--flake" ]]; then
                flake_ref="$arg"
            fi
            ;;
    esac
done

if [[ -z "$action" ]]; then
    echo "Usage: nixos-rebuild-safe <switch|boot|test|build> [options]"
    echo "Example: nixos-rebuild-safe switch --flake .#rock5c_minimal"
    exit 1
fi

# Check if overlay is active
overlay_active=false
if findmnt -n -t overlay /nix/store > /dev/null 2>&1; then
    overlay_active=true
fi

cleanup() {
    if [[ "$overlay_active" == "true" ]]; then
        echo "==> Re-enabling overlay store..."
        systemctl restart nix-overlay-store-setup || true
        systemctl restart nix-daemon || true
    fi
}
trap cleanup EXIT

if [[ "$overlay_active" == "true" ]]; then
    echo "==> Overlay store detected"
    echo "==> Phase 1: Building system with overlay active..."
    echo ""

    # Build the system toplevel while overlay is active
    # This ensures all paths (including flake source) are accessible
    if [[ -n "$flake_ref" ]]; then
        # Extract the flake path and config name
        flake_path="${flake_ref%#*}"
        config_name="${flake_ref#*#}"

        echo "==> Building: nix build ${flake_path}#nixosConfigurations.${config_name}.config.system.build.toplevel"
        toplevel=$(nix build "${flake_path}#nixosConfigurations.${config_name}.config.system.build.toplevel" --print-out-paths --no-link)
    else
        echo "==> Building system configuration..."
        toplevel=$(nixos-rebuild build "${extra_args[@]}" --no-link 2>&1 | tail -1)
        # Fallback: try to get the path from the symlink
        if [[ ! -d "$toplevel" ]]; then
            nixos-rebuild build "${extra_args[@]}"
            toplevel=$(readlink -f ./result)
            rm -f ./result
        fi
    fi

    echo ""
    echo "==> Built system: $toplevel"
    echo ""

    # Now disable overlay and fetch to eMMC
    echo "==> Phase 2: Disabling overlay, fetching to eMMC..."
    echo ""

    # Stop nix daemon
    echo "==> Stopping nix-daemon..."
    systemctl stop nix-daemon.socket nix-daemon.service || true

    # Unmount overlay
    echo "==> Unmounting overlay from /nix/store..."
    umount -l /nix/store || true

    # Clear overlay config
    echo "==> Clearing overlay store config..."
    echo "# Temporarily disabled for safe rebuild" > /run/nix-overlay-store.env

    # Restart daemon with default store
    echo "==> Starting nix-daemon with eMMC store..."
    systemctl start nix-daemon.socket

    echo ""
    echo "==> Phase 3: Fetching system closure to eMMC from binary cache..."
    echo ""

    # Realize the path - this fetches from binary cache to eMMC
    nix-store --realise "$toplevel" --option substitute true

    echo ""
    echo "==> Phase 4: Activating system..."
    echo ""

    # Now activate based on the action
    case "$action" in
        switch)
            nix-env -p /nix/var/nix/profiles/system --set "$toplevel"
            "$toplevel/bin/switch-to-configuration" switch
            ;;
        boot)
            nix-env -p /nix/var/nix/profiles/system --set "$toplevel"
            "$toplevel/bin/switch-to-configuration" boot
            ;;
        test)
            "$toplevel/bin/switch-to-configuration" test
            ;;
        build)
            echo "Build complete: $toplevel"
            ;;
        dry-build|dry-activate)
            echo "Dry run - system at: $toplevel"
            ;;
    esac
else
    # No overlay, just run nixos-rebuild directly
    echo "==> No overlay detected, running nixos-rebuild directly..."
    nixos-rebuild "$@"
fi

echo ""
echo "==> System rebuild complete (written to eMMC)"
# cleanup runs automatically via trap
