#!/usr/bin/env bash
# nixos-rebuild-safe: Rebuild NixOS directly to eMMC, bypassing overlay store
# This ensures the system can boot without the SSD.

set -euo pipefail

if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root (use sudo)"
    exit 1
fi

# Check if overlay is active
overlay_active=false
if findmnt -n -t overlay /nix/store > /dev/null 2>&1; then
    overlay_active=true
    echo "==> Overlay store detected, temporarily disabling..."
fi

cleanup() {
    if [[ "$overlay_active" == "true" ]]; then
        echo "==> Re-enabling overlay store..."
        systemctl restart nix-overlay-store-setup || true
        systemctl restart nix-daemon || true
    fi
}
trap cleanup EXIT

if [[ "$overlay_active" == "true" ]]; then
    # Stop nix daemon
    echo "==> Stopping nix-daemon..."
    systemctl stop nix-daemon.socket nix-daemon.service || true

    # Unmount overlay
    echo "==> Unmounting overlay from /nix/store..."
    umount -l /nix/store || true

    # Clear overlay config
    echo "==> Clearing overlay store config..."
    echo "# Temporarily disabled for safe rebuild" > /run/nix-overlay-store.env

    # Restart daemon with default store
    echo "==> Starting nix-daemon with eMMC store..."
    systemctl start nix-daemon.socket
fi

# Run nixos-rebuild with all passed arguments
echo "==> Running: nixos-rebuild $*"
echo ""
nixos-rebuild "$@"

echo ""
echo "==> System rebuild complete (written to eMMC)"
# cleanup runs automatically via trap
