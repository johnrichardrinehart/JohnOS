#!/usr/bin/env bash
set -euo pipefail

# These values are replaced at build time by Nix
MOUNT_POINT="@mountPoint@"
UPPER_LAYER="@upperLayer@"
WORK_DIR="@workDir@"
BUILD_DIR="@buildDir@"
OVERLAY_STORE_URL="@overlayStoreUrl@"

NIX_STORE="/nix/store"
ENV_FILE="/run/nix-overlay-store.env"
STATE_FILE="/run/nix-overlay-store.mode"

echo "==> Enabling overlay store..."

# Check if SSD mounts are available
if ! mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
  echo "Mounting SSD..."
  systemctl start "$(systemd-escape -p "$MOUNT_POINT").mount" || {
    echo "Error: Failed to mount $MOUNT_POINT"
    echo "Is the SSD connected?"
    exit 1
  }
fi

if ! mountpoint -q "$UPPER_LAYER" 2>/dev/null; then
  systemctl start "$(systemd-escape -p "$UPPER_LAYER").mount" || {
    echo "Error: Failed to mount $UPPER_LAYER"
    exit 1
  }
fi

if ! mountpoint -q "$BUILD_DIR" 2>/dev/null; then
  systemctl start "$(systemd-escape -p "$BUILD_DIR").mount" || {
    echo "Error: Failed to mount $BUILD_DIR"
    exit 1
  }
fi

# Ensure directories exist
mkdir -p "$UPPER_LAYER/nix/store" "$WORK_DIR"

# Stop nix-daemon before modifying /nix/store
echo "Stopping nix-daemon..."
systemctl stop nix-daemon.socket nix-daemon.service 2>/dev/null || true

# Mount overlay if not already mounted
if ! findmnt -n -t overlay "$NIX_STORE" > /dev/null 2>&1; then
  echo "Mounting overlay on $NIX_STORE..."
  mount -t overlay overlay \
    -o "lowerdir=$NIX_STORE,upperdir=$UPPER_LAYER/nix/store,workdir=$WORK_DIR" \
    "$NIX_STORE"
else
  echo "Overlay already mounted"
fi

# Write environment file for nix-daemon
cat > "$ENV_FILE" <<EOF
TMPDIR=$BUILD_DIR
NIX_CONFIG=store = ${OVERLAY_STORE_URL}&check-mount=false
build-dir = $BUILD_DIR
EOF

# Mark state
echo "overlay" > "$STATE_FILE"

# Start nix-daemon
echo "Starting nix-daemon..."
systemctl start nix-daemon.socket

echo "==> Overlay store enabled"
echo "    Builds will use SSD upper layer"
echo "    Run 'nix-overlay-disable' before system/profile changes"
