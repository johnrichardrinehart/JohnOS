#!/usr/bin/env bash
set -euo pipefail

# These values are replaced at build time by Nix
MOUNT_POINT="@mountPoint@"
UPPER_LAYER="@upperLayer@"
WORK_DIR="@workDir@"
BUILD_DIR="@buildDir@"
OVERLAY_STORE_URL="@overlayStoreUrl@"

NIX_STORE="/nix/store"
STATE_FILE="/run/nix-overlay-store.mode"

echo "==> Enabling overlay store..."

# Check if SSD mounts are available
if ! mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
  echo "Mounting SSD..."
  systemctl start "$(systemd-escape -p "$MOUNT_POINT").mount" || {
    echo "Error: Failed to mount $MOUNT_POINT"
    echo "Is the SSD connected?"
    exit 1
  }
fi

if ! mountpoint -q "$UPPER_LAYER" 2>/dev/null; then
  systemctl start "$(systemd-escape -p "$UPPER_LAYER").mount" || {
    echo "Error: Failed to mount $UPPER_LAYER"
    exit 1
  }
fi

if ! mountpoint -q "$BUILD_DIR" 2>/dev/null; then
  systemctl start "$(systemd-escape -p "$BUILD_DIR").mount" || {
    echo "Error: Failed to mount $BUILD_DIR"
    exit 1
  }
fi

# Ensure directories exist
mkdir -p "$UPPER_LAYER/nix/store" "$WORK_DIR"

# Stop nix-daemon before modifying /nix/store
echo "Stopping nix-daemon..."
systemctl stop nix-daemon.socket nix-daemon.service 2>/dev/null || true

# Mount overlay if not already mounted
if ! findmnt -n -t overlay "$NIX_STORE" > /dev/null 2>&1; then
  echo "Mounting overlay on $NIX_STORE..."
  mount -t overlay overlay \
    -o "lowerdir=$NIX_STORE,upperdir=$UPPER_LAYER/nix/store,workdir=$WORK_DIR" \
    "$NIX_STORE"
else
  echo "Overlay already mounted"
fi

# Create wrapper script that sets environment and execs nix-daemon
# This is necessary because systemd can't handle newlines in Environment= values
WRAPPER="/run/nix-daemon-wrapper"
cat > "$WRAPPER" <<'WRAPPEREOF'
#!/bin/bash
export TMPDIR="@buildDir@"
export NIX_CONFIG=$'store = @overlayStoreUrl@&check-mount=false\nbuild-dir = @buildDir@'
exec /nix/var/nix/profiles/default/bin/nix-daemon "$@"
WRAPPEREOF
# Substitute the actual values
sed -i "s|@buildDir@|$BUILD_DIR|g; s|@overlayStoreUrl@|$OVERLAY_STORE_URL|g" "$WRAPPER"
chmod +x "$WRAPPER"

# Create systemd drop-in to use the wrapper
DROPIN_DIR="/run/systemd/system/nix-daemon.service.d"
mkdir -p "$DROPIN_DIR"
cat > "$DROPIN_DIR/overlay-store.conf" <<DROPINEOF
[Service]
ExecStart=
ExecStart=$WRAPPER
DROPINEOF

# Mark state
echo "overlay" > "$STATE_FILE"

# Reload systemd to pick up the drop-in, then start nix-daemon
echo "Reloading systemd and starting nix-daemon..."
systemctl daemon-reload
systemctl start nix-daemon.socket

echo "==> Overlay store enabled"
echo "    Builds will use SSD upper layer"
echo "    Run 'nix-overlay-disable' before system/profile changes"
