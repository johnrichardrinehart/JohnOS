#!/usr/bin/env bash
# nix-overlay-setup: Mount overlay and configure nix-daemon at boot
# This script is run by systemd at boot time

set -euo pipefail

UPPER="@upperLayer@"
WORK="@workDir@"
BUILD_DIR="@buildDir@"
OVERLAY_STORE_URL="@overlayStoreUrl@"
NIX_STORE="/nix/store"

# Ensure directories exist
mkdir -p "$UPPER/nix/store" "$WORK"

# Mount overlay if not already mounted
if ! findmnt -n -t overlay "$NIX_STORE" > /dev/null 2>&1; then
  echo "Mounting overlay on $NIX_STORE..."
  mount -t overlay overlay \
    -o "lowerdir=$NIX_STORE,upperdir=$UPPER/nix/store,workdir=$WORK" \
    "$NIX_STORE"
fi

# Create nix-daemon wrapper with overlay store config
cat > /run/nix-daemon-wrapper <<EOF
#!/run/current-system/sw/bin/bash
export TMPDIR="$BUILD_DIR"
export NIX_CONFIG=\$'store = ${OVERLAY_STORE_URL}&check-mount=false\nbuild-dir = $BUILD_DIR'
exec /run/current-system/sw/bin/nix-daemon "\$@"
EOF
chmod +x /run/nix-daemon-wrapper

# Create systemd drop-in
mkdir -p /run/systemd/system/nix-daemon.service.d
cat > /run/systemd/system/nix-daemon.service.d/overlay-store.conf <<EOF
[Service]
ExecStart=
ExecStart=/run/nix-daemon-wrapper
EOF

systemctl daemon-reload
echo "Overlay store ready"
