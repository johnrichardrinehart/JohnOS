#!/usr/bin/env bash
# nixos-rebuild-bake: Rebuild NixOS and write to eMMC (lower store)
# This ensures the system can boot without the SSD.
#
# Strategy:
# 1. Build with overlay active (fast SSD builds)
# 2. Mount eMMC root to separate location
# 3. Copy closure directly to eMMC's nix store using cp (not nix copy)
# 4. Update eMMC's system profile
#
# Note: We use cp instead of nix copy because the eMMC and overlay share
# the same nix database (only /nix/store is overlaid, not /nix/var/nix/db).
# nix copy checks the database and thinks paths already exist on eMMC.

set -euo pipefail

if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root (use sudo)"
    exit 1
fi

# Get the original user (for running build without root)
ORIGINAL_USER="${SUDO_USER:-$USER}"

action="${1:-}"
shift || true

if [[ -z "$action" ]] || [[ ! "$action" =~ ^(switch|boot|test|build)$ ]]; then
    echo "Usage: nixos-rebuild-bake <switch|boot|test|build> [options]"
    echo "Example: nixos-rebuild-bake switch --flake .#rock5c_minimal"
    exit 1
fi

EMMC_DEV="/dev/disk/by-label/NIXOS_SD"
EMMC_MNT=$(mktemp -d --tmpdir nixos-rebuild-bake.XXXXXX)

# Build with overlay active (fast)
# Run as original user to avoid creating root-owned cache files
# Force daemon usage so we get the overlay store config (build-dir on SSD)
echo "==> Building system..."
sudo -u "$ORIGINAL_USER" env NIX_REMOTE=daemon nixos-rebuild build "$@"
toplevel=$(readlink -f ./result)
rm -f ./result
echo "==> Built: $toplevel"

if [[ "$action" == "build" ]]; then
    echo "==> Build complete"
    exit 0
fi

# Mount eMMC root partition
echo "==> Mounting eMMC to $EMMC_MNT..."
mount "$EMMC_DEV" "$EMMC_MNT"
trap 'umount "$EMMC_MNT"; rmdir "$EMMC_MNT"' EXIT

# Copy closure to eMMC
# The nix database is shared between overlay and eMMC, so nix copy thinks paths exist.
# Instead, we directly copy the files that are missing from eMMC.
# If the path is on the SSD upper layer, move it to eMMC (copy + delete source).
#
# We copy both:
# 1. Runtime closure (outputs) - needed to run the system
# 2. Build closure (derivations + inputs) - needed to rebuild offline
SSD_UPPER="/mnt/nix-ssd/@upper"
echo "==> Collecting closures (runtime + build inputs + their outputs)..."
drv=$(nix-store -qd "$toplevel")
# Query closure in background, list SSD upper in parallel
closure_file=$(mktemp)
upper_file=$(mktemp)
trap 'umount "$EMMC_MNT"; rmdir "$EMMC_MNT"; rm -f "$closure_file" "$upper_file"' EXIT

nix-store -qR --include-outputs "$drv" "$toplevel" | sed 's|.*/||' | sort -u > "$closure_file" &
ls "$SSD_UPPER/nix/store/" 2>/dev/null | sort > "$upper_file" &
wait
echo "==> Closure: $(wc -l < "$closure_file") paths, SSD upper: $(wc -l < "$upper_file") paths"

# Find closure paths that exist on SSD upper (need to be moved)
# Use comm to intersect closure basenames with SSD upper contents
paths_to_move=$(comm -12 "$closure_file" "$upper_file")

if [ -n "$paths_to_move" ]; then
    count=$(echo "$paths_to_move" | wc -l)
    echo "==> Moving $count paths from SSD to eMMC..."
    rsync -a --remove-source-files \
        --files-from=<(echo "$paths_to_move") \
        "$SSD_UPPER/nix/store/" "$EMMC_MNT/nix/store/"
    # Clean up empty directories left behind
    find "$SSD_UPPER/nix/store" -mindepth 1 -type d -empty -delete 2>/dev/null || true
else
    echo "==> All paths already on eMMC"
fi
if ! ls "$EMMC_MNT/nix/store/$(basename $toplevel)" > /dev/null 2>&1; then
    echo "ERROR: Copy failed - path not found on eMMC!"
    exit 1
fi
echo "==> Verified: path exists on eMMC"

# Update system profile on eMMC
if [[ "$action" == "switch" || "$action" == "boot" ]]; then
    echo "==> Setting system profile on eMMC..."
    nix-env --store "local?root=$EMMC_MNT" \
        -p "$EMMC_MNT/nix/var/nix/profiles/system" \
        --set "$toplevel"
fi

# Activate if switch or test
# Use systemd-run to survive SSH disconnection during service restarts
if [[ "$action" == "switch" || "$action" == "test" ]]; then
    echo "==> Activating system..."
    systemd-run \
        -E LOCALE_ARCHIVE \
        -E NIXOS_INSTALL_BOOTLOADER=0 \
        --collect \
        --no-ask-password \
        --pipe \
        --quiet \
        --service-type=exec \
        --unit=nixos-rebuild-switch-to-configuration \
        --wait \
        "$toplevel/bin/switch-to-configuration" "$action"
fi

echo "==> Done (system written to eMMC)"
