#!/usr/bin/env bash
# nix-collect-garbage-safe: Run garbage collection with overlay enabled
# This ensures GC sees both lower (SD card) and upper (SSD) store paths,
# preventing deletion of dependencies needed by the upper store.

set -euo pipefail

if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root (use sudo)"
    exit 1
fi

# Require overlay to be active so GC sees all paths
if ! findmnt -n -t overlay /nix/store > /dev/null 2>&1; then
    echo "Error: Overlay store not active."
    echo ""
    echo "Garbage collection must run with the overlay enabled so it sees"
    echo "paths in both the lower store (SD card) and upper store (SSD)."
    echo "Otherwise, dependencies needed by SSD paths may be deleted."
    echo ""
    echo "Run 'nix-overlay-enable' first, then retry."
    exit 1
fi

# Show before stats
echo "==> Store before (overlay active):"
df -h /nix/store | tail -1

# Run garbage collection with all passed arguments
echo ""
echo "==> Running: nix-collect-garbage $*"
echo ""
nix-collect-garbage "$@"

# Show after stats
echo ""
echo "==> Store after:"
df -h /nix/store | tail -1

echo ""
echo "==> Garbage collection complete"
