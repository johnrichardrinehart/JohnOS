#!/usr/bin/env bash
# nixos-rebuild-local: Build on overlay, bake to SD card, switch
#
# This script:
# 1. Builds the system closure using the overlay store (fast, uses SSD)
# 2. Copies the closure to the lower store (SD card) using nix copy
# 3. Switches to the new configuration

set -euo pipefail

if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root (use sudo)"
  exit 1
fi

FLAKE_ATTR="${1:-}"
if [[ -z "$FLAKE_ATTR" ]]; then
  echo "Usage: nixos-rebuild-local .#nixosConfigurations.HOSTNAME"
  echo "   or: nixos-rebuild-local /path/to/flake#nixosConfigurations.HOSTNAME"
  exit 1
fi

LOWER_STORE_DEV="@lowerStoreDev@"
LOWER_MNT=$(mktemp -d)

trap "umount '$LOWER_MNT' 2>/dev/null || true; rmdir '$LOWER_MNT' 2>/dev/null || true" EXIT

# Verify overlay is active
if ! findmnt -n -t overlay /nix/store > /dev/null 2>&1; then
  echo "Error: Overlay store not active."
  echo "This script requires the overlay to be mounted."
  exit 1
fi

echo "==> Building system closure..."
BUILD_RESULT=$(nix build "${FLAKE_ATTR}.config.system.build.toplevel" --print-out-paths --no-link)
echo "    Built: $BUILD_RESULT"

echo "==> Mounting SD card..."
mount "$LOWER_STORE_DEV" "$LOWER_MNT"

echo "==> Copying closure to SD card..."
nix copy --to "file://$LOWER_MNT/nix/store" "$BUILD_RESULT"

# Sync and unmount
sync
umount "$LOWER_MNT"

echo "==> Switching to new configuration..."
"$BUILD_RESULT/bin/switch-to-configuration" switch

echo "==> Done!"
echo "    System is now running: $BUILD_RESULT"
echo ""
echo "    Closure was copied to the SD card."
echo "    The system will boot correctly even without the SSD."
