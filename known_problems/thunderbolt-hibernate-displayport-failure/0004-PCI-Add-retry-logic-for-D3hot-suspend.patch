From: John Rinehart <john@example.com>
Date: Wed, 8 Jan 2026 20:00:00 -0500
Subject: [PATCH] PCI: Add retry logic for D0 to D3hot power state transitions

Some devices, particularly Thunderbolt PCIe bridges, may be transiently
inaccessible when the system attempts to put them into D3hot during
suspend. This can happen when the PCIe link is in a transitional state
or ASPM is causing momentary link unavailability.

This is observed on Intel Tiger Lake systems with Thunderbolt 4 during
suspend entry. The Goshen Ridge bridges (8086:0b26) occasionally return
0xFFFF when config space is read, causing:

  pcieport 0000:81:04.0: Unable to change power state from D0 to D3hot, device inaccessible

This causes the Thunderbolt link to reset, disconnecting all downstream
devices including DisplayPort tunnels. After resume, the displays fail
to re-establish even though USB devices recover.

Add a retry loop with exponential backoff (20-80ms) for the initial
config space read in pci_set_low_power_state(). Devices that respond
correctly pass on the first attempt with no added latency.

Tested on Framework Laptop 13 (11th Gen Intel) with Dell U3225QE
Thunderbolt monitor.

Signed-off-by: John Rinehart <john@example.com>
---
 drivers/pci/pci.c | 22 ++++++++++++++++++++--
 1 file changed, 20 insertions(+), 2 deletions(-)

diff --git a/drivers/pci/pci.c b/drivers/pci/pci.c
index b14dd064006cc..e331e00cd01f2 100644
--- a/drivers/pci/pci.c
+++ b/drivers/pci/pci.c
@@ -1466,6 +1466,7 @@ static void __pci_bus_set_current_state(struct pci_bus *bus, pci_power_t state,
 static int pci_set_low_power_state(struct pci_dev *dev, pci_power_t state, bool locked)
 {
 	u16 pmcsr;
+	int retries;

 	if (!dev->pm_cap)
 		return -EIO;
@@ -1488,11 +1489,28 @@ static int pci_set_low_power_state(struct pci_dev *dev, pci_power_t state, bool
 	   || (state == PCI_D2 && !dev->d2_support))
 		return -EIO;

-	pci_read_config_word(dev, dev->pm_cap + PCI_PM_CTRL, &pmcsr);
+	/*
+	 * Some devices, particularly Thunderbolt PCIe bridges, may be
+	 * transiently inaccessible when entering low power states. This
+	 * can occur during suspend when the PCIe link is in a transitional
+	 * state or ASPM is causing momentary link unavailability.
+	 * Retry a few times with increasing delays before giving up.
+	 */
+	for (retries = 0; retries < 4; retries++) {
+		if (retries > 0) {
+			unsigned int delay_ms = 10 << retries; /* 20, 40, 80 ms */
+			pci_dbg(dev, "low power transition: retry %d, waiting %u ms\n",
+				retries, delay_ms);
+			msleep(delay_ms);
+		}
+		pci_read_config_word(dev, dev->pm_cap + PCI_PM_CTRL, &pmcsr);
+		if (!PCI_POSSIBLE_ERROR(pmcsr))
+			break;
+	}
 	if (PCI_POSSIBLE_ERROR(pmcsr)) {
-		pci_err(dev, "Unable to change power state from %s to %s, device inaccessible\n",
+		pci_err(dev, "Unable to change power state from %s to %s, device inaccessible after %d retries\n",
 			pci_power_name(dev->current_state),
-			pci_power_name(state));
+			pci_power_name(state), retries);
 		dev->current_state = PCI_D3cold;
 		return -EIO;
 	}
--
2.43.0
