From: John Rinehart <john@example.com>
Date: Wed, 8 Jan 2026 10:30:00 -0500
Subject: [PATCH] PCI: Add retry logic for D3cold to D0 power state transitions

Some devices, particularly Thunderbolt controllers, need additional time
to become accessible after ACPI powers them on from D3cold. Currently
pci_power_up() reads the PM_CTRL register immediately after requesting
power-on and fails if the device isn't ready.

This is observed on Intel Tiger Lake systems with Thunderbolt 4 after
hibernate resume. The Goshen Ridge bridges (8086:0b26) return 0xFFFF
when read too early, causing:

  pcieport 0000:80:00.0: Unable to change power state from D3cold to D0, device inaccessible

This prevents DisplayPort tunneling from being re-established, leaving
external monitors without signal even though USB devices on the same
Thunderbolt connection recover successfully.

Add a retry loop with exponential backoff (20-160ms) for devices that
were in D3cold, giving them time to initialize after platform power-on
before giving up. Devices that resume correctly pass on the first
attempt with no added latency.

Tested on Framework Laptop 13 (11th Gen Intel) with Dell U3225QE
Thunderbolt monitor. Before this patch, hibernate resume fails
approximately 100% of the time. After this patch, DisplayPort tunnels
are successfully re-established.

Signed-off-by: John Rinehart <john@example.com>
---
 drivers/pci/pci.c | 27 +++++++++++++++++++++++----
 1 file changed, 23 insertions(+), 4 deletions(-)

diff --git a/drivers/pci/pci.c b/drivers/pci/pci.c
index b14dd064006cc..9d065fa2d410a 100644
--- a/drivers/pci/pci.c
+++ b/drivers/pci/pci.c
@@ -1304,6 +1304,8 @@ int pci_power_up(struct pci_dev *dev)
 {
 	bool need_restore;
 	pci_power_t state;
+	pci_power_t prev_state = dev->current_state;
+	int retries;
 	u16 pmcsr;

 	platform_pci_set_power_state(dev, PCI_D0);
@@ -1323,10 +1325,28 @@ int pci_power_up(struct pci_dev *dev)
 		return -EIO;
 	}

-	pci_read_config_word(dev, dev->pm_cap + PCI_PM_CTRL, &pmcsr);
+	/*
+	 * Devices resuming from D3cold may need additional time to become
+	 * accessible after platform power-on. This is particularly common
+	 * with Thunderbolt controllers after hibernate resume where the
+	 * controller needs time to initialize after power rails stabilize.
+	 * Retry a few times with increasing delays before giving up.
+	 */
+	for (retries = 0; retries < 5; retries++) {
+		if (retries > 0 && prev_state == PCI_D3cold) {
+			unsigned int delay_ms = 20 << (retries - 1);
+			pci_dbg(dev, "D3cold resume: retry %d, waiting %u ms\n",
+				retries, delay_ms);
+			msleep(delay_ms);
+		}
+		pci_read_config_word(dev, dev->pm_cap + PCI_PM_CTRL, &pmcsr);
+		if (!PCI_POSSIBLE_ERROR(pmcsr))
+			break;
+	}
+
 	if (PCI_POSSIBLE_ERROR(pmcsr)) {
-		pci_err(dev, "Unable to change power state from %s to D0, device inaccessible\n",
-			pci_power_name(dev->current_state));
+		pci_err(dev, "Unable to change power state from %s to D0, device inaccessible after %d retries\n",
+			pci_power_name(prev_state), retries);
 		dev->current_state = PCI_D3cold;
 		return -EIO;
 	}
--
2.43.0
